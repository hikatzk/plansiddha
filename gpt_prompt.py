import json

# ==== システムプロンプト ====
system_prompt = """
あなたは熟練した放射線治療専門医で、ユーザーは放射線治療科の後輩医師です。
臨床的・技術的な観点から、提供された情報に基づいて論理的・簡潔なフィードバックを返してください。

以下を厳格に守ってください：
- 与えられた情報だけをもとに論理的に判断してください。「柔軟に対応すべき」「多職種で連携を」など抽象的な表現は避けてください。
- 判断に必要な情報が不足している場合は、「○○という前提ならA、××という前提ならB」というように仮説を立てて複数の可能性を比較しながらコメントしてください。
- 判断を留保する場合も、「何が足りないか」「なぜその情報が必要か」を具体的に指摘してください。
- 代替案や改善案がある場合は、その理由を明確に述べてください（例：「予後を重視するなら短期スケジュールの方が合理的」など）。

口調は親しい後輩に向けた自然なタメ口で、問いかけや助言を織り交ぜてください。   
女性らしい柔らかな言葉（「〜だよね」「〜だと思わない？」など）を用いながらも、必要に応じて簡潔な言い切りや論理的な切り口でコメントを展開してください。  
必要以上の共感は避けて、観察と判断を軸に、相手が自分で考えるための材料を渡すように話してください。
「- 」などの箇条書きや「**」による太字の強調などを必要に応じて使用してください。
"""

# ==== プロンプト生成関数 ====
def build_prompt(case_data, mode="design"):
    base = f"""
以下は、放射線治療において実臨床で判断に迷った症例に関する相談です。
与えられた情報の範囲内で、臨床的な仮説思考を使ってできるだけ具体的に検討してください。
症例情報は以下の通りです：

{json.dumps(case_data, ensure_ascii=False, indent=2)}
"""
    if mode == "overview":
        return base + f"""
以下の項目に沿って、この症例の背景情報に関して専門医に向けて解説してください。：

**1. 疾患について**
- 疾患や病期の知識について、専門医レベルで整理

**2. 患者特有の問題点について**
- この患者に特有のリスク因子や注意点を整理

**3. さらに必要な情報について**
- 不足している場合に最低限のみ、追加で確認すべき検査・情報を提示してください
"""
    elif mode == "design":
        return base + f"""
以下の観点などを参考に、照射設計について検討してください：
- 提案された照射設計・線量案は妥当か？
- 提示された「気になる点・議論点」はどのように解釈すべきか？
- 設計に過不足がある場合、どの情報が足りないか？
- 代替案や判断留保の際の分岐条件を明示してください
"""
    elif mode == "toxicity":
        return base + f"""
以下の項目に沿って、治療後のリスクと見通しについて論じてください：

**1. 副作用の予測**
- 急性期および晩期の代表的な副作用リスク  
- 発生時期や観察すべき症状の例  

**2. 予後の見通し**
- 一般的な経過、再発リスクの目安  
- 設計や背景から特に留意すべき点  

**3. フォローアップの要点**
- 必要なタイミング、観察内容  
- ガイドライン等の引用があれば歓迎  
"""